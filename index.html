<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rimozione Sfondo(green screen)</title>
<meta name="description" content="Clicca un punto: la macchia verde si espande finché il gradiente locale (forza resistente) è sotto la Forza scelta. Poi puoi rimuovere i pixel verdi come sfondo e scaricare il PNG. 100% client-side.">
<style>
  :root{ --bg1:#0f1226; --bg2:#0b0e1a; --muted:#8e95ad; --brand:#6a8dff; --brand2:#9d78ff;
         --card:#171a33; --radius:18px; --shadow:0 10px 25px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.2); }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e7e9f3;
    background: radial-gradient(1200px 600px at 10% -10%, #2631a7 0%, transparent 60%),
               radial-gradient(1200px 700px at 100% 0%, #6a22a8 0%, transparent 50%),
               linear-gradient(180deg, var(--bg1), var(--bg2));
    padding:28px; display:flex; align-items:center; justify-content:center;
  }
  .app{width:min(980px,100%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .title{display:flex;align-items:center;gap:14px}
  .logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:var(--shadow)}
  .logo svg{filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))}
  h1{font-size:clamp(18px,3vw,28px);margin:0}
  .muted{color:var(--muted)}
  .panel{background:rgba(23,26,51,.72);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
  .uploader{display:grid;grid-template-rows:auto 1fr auto}
  .top{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
  .badge{font-size:12px;line-height:1;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
  .dropzone{margin:16px;border:1.5px dashed rgba(255,255,255,.18);border-radius:16px;display:grid;place-items:center;padding:20px;min-height:160px;
            background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));transition:.2s;text-align:center}
  .dropzone.drag{border-color:var(--brand);box-shadow:inset 0 0 0 2px rgba(106,141,255,.25)}
  .dropzone input{display:none}
  .dz-cta{display:flex;flex-direction:column;gap:10px;align-items:center}
  .btn{appearance:none;border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0b0e1a;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:transparent;color:#e7e9f3;border:1px solid rgba(255,255,255,.16)}
  .btn[disabled]{opacity:.9;filter:grayscale(40%);cursor:not-allowed}
  .controls{display:flex;gap:14px;align-items:center;flex-wrap:wrap;padding:0 16px 16px 16px}
  .range{appearance:none;background:rgba(255,255,255,.04);color:#e7e9f3;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:10px 12px}
  .muted-sm{color:var(--muted);font-size:12px}
  .preview{margin:0 16px 16px 16px;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;background:#0b0e1a}
  .preview-inner{max-height:560px;overflow:auto;display:grid;place-items:center;padding:12px}
  .checker{background-image:linear-gradient(45deg,#999 25%,transparent 25%),linear-gradient(-45deg,#999 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#999 75%),linear-gradient(-45deg,transparent 75%,#999 75%);
           background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0}
  .preview-inner{max-width:100%}
  canvas{display:block; max-width:100%; height:auto}

  /* Barra comandi flottante sempre visibile */
  .controls-float{
    position: fixed;
    right: 16px;
    bottom: max(16px, env(safe-area-inset-bottom));
    z-index: 3000;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    background: rgba(18,20,38,.72);
    border: 1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(6px);
    box-shadow: var(--shadow);
  }

  .toast{position:fixed;z-index:3200;right:18px;bottom:72px;background:#121426;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.2s ease}
  .toast.show{opacity:1;transform:translateY(0)}
  
  
.splash-logo{
  width: 96px;           /* adatta se vuoi più grande/piccolo */
  height: 96px;
  border-radius: 16px;   /* se il tuo logo è quadrato e vuoi angoli soft */
  box-shadow: var(--shadow);
  object-fit: contain;   /* mantiene proporzioni */
  background: transparent;
  /* se serve più contrasto sul fondo scuro: */
  filter: drop-shadow(0 2px 8px rgba(0,0,0,.35));
}

/* (facoltativo) piccola animazione “pop” all’ingresso */
#splash .splash-logo{
  transform: scale(.98);
  animation: logoPop .6s ease .2s forwards;
}
@keyframes logoPop{
  to { transform: scale(1); }
}
  
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="18" height="18" rx="5" fill="white"/>
          <path d="M7 16 L10 8 L13 16 Z" fill="#6a8dff"/>
          <circle cx="16" cy="10" r="3" fill="#9d78ff"/></svg>
        </div>
        <div>
          <h1>Rimozione sfondo — DP Web & Design</h1>
          <div class="muted">Clicca sull’immagine. La macchia si espande finché la resistenza (gradiente) ≤ Forza.</div>
        </div>
      </div>
    </header>

    <!-- Barra flottante fissa -->
    <div class="controls-float">
      <button class="btn secondary" id="btnRemoveGreen" disabled>Rimuovi verde</button>
      <button class="btn secondary" id="btnDownload" disabled>Scarica PNG</button>
      <button class="btn secondary" id="btnReset">Ripristina</button>
    </div>

    <section class="panel uploader">
      <div class="top">
        <span class="badge">1</span>
        <div>
          <div style="font-weight:700">Carica o trascina una foto, poi CLICCA per espandere</div>
          <div class="muted-sm">JPG, PNG, WebP • 100% offline</div>
        </div>
      </div>

      <div class="dropzone" id="dropzone" aria-live="polite">
        <div class="dz-cta">
          <div class="muted">Trascina qui l’immagine</div>
		  <div class="muted"> </div>
          <div><label class="btn" for="fileInput">Scegli file</label><input id="fileInput" type="file" accept="image/*"/></div>
        </div>
      </div>

      <div class="controls">
        <span class="badge">2</span>
        <label style="display:flex;align-items:center;gap:10px">
          <span class="muted-sm">Forza</span>
          <input id="force" class="range" type="range" min="0" max="25" value="10" />
          <strong id="forceVal">10</strong><span class="muted-sm">/255</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px">
          <span class="muted-sm">Raggio max</span>
          <input id="maxr" class="range" type="range" min="0" max="500" value="20" />
          <strong id="maxrVal">20</strong><span class="muted-sm"> passi</span>
        </label>
        <span class="muted-sm">Tip: valori bassi seguono i bordi, alti “sfondano”.</span>
      </div>

      <div class="preview checker">
        <div class="preview-inner">
          <canvas id="cnvOut"></canvas>
        </div>
      </div>
    </section>
  </div>

  <!-- Splash DP Web & Design -->
  <div id="splash"
       aria-hidden="true"
       style="position:fixed;inset:0;z-index:4000;display:grid;place-items:center;background:#0f1226;color:#fff;
              font-family:inherit;font-size:clamp(26px,4vw,48px);font-weight:900;letter-spacing:.8px;animation:fadeOut .9s ease 1.4s forwards;">
    <div class="splash-bg" style="position:absolute;inset:-20%;
      background:radial-gradient(1200px 600px at 10% -10%, #2631a7 0%, transparent 60%),
                 radial-gradient(1200px 700px at 100% 0%, #6a22a8 0%, transparent 50%),
                 radial-gradient(900px 500px at 20% 120%, #0ea5e9 0%, transparent 55%);
      filter:blur(30px);opacity:.85;animation:floatBg 8s ease-in-out infinite alternate;"></div>
    <div style="position:relative;display:grid;place-items:center;gap:12px;text-align:center;padding:16px 22px">
	<img id="splashLogo"
		 class="splash-logo"
		 src="assets/logo.png"
		 alt="DP Web & Design"
		 width="96" height="96"
		 decoding="async"
		 fetchpriority="high" />
   	  <div>DP Web & Design</div>
      <button id="skipSplash" class="btn secondary" style="padding:10px 14px;border-radius:12px;cursor:pointer">Entra subito</button>
    </div>
  </div>
  <style>
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}
    @keyframes floatBg{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(-2%,-2%,0) scale(1.03)}}
    @media (prefers-reduced-motion: reduce){ #splash{animation:none} .splash-bg{animation:none} }
  </style>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Helpers & Splash ===== */
const $=s=>document.querySelector(s);
const showToast=msg=>{const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)};
(function(){const s=$('#splash'), b=$('#skipSplash'); const rm=()=>{if(!s) return; s.style.animation='fadeOut .5s ease forwards'; setTimeout(()=>s.remove(),520)}; setTimeout(rm,1600); b?.addEventListener('click',rm);})();

/* ===== HiDPI canvas ===== */
function setupCanvasHiDPI(cnv, cssW, cssH){
  const dpr=window.devicePixelRatio||1;
  cnv.width=Math.max(1,Math.round(cssW*dpr));
  cnv.height=Math.max(1,Math.round(cssH*dpr));
  cnv.style.width=cssW+'px';
  cnv.style.height=cssH+'px';
  const ctx=cnv.getContext('2d',{willReadFrequently:true});
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled=true;
  ctx.imageSmoothingQuality='high';
  return ctx;
}

/* ===== Stato & Riferimenti ===== */
let off=null, offCtx=null;         // canvas offscreen “alla scala giusta”
let lum=null, grad=null;           // luminanza Uint8, resistenza (gradiente) Uint8 0..255
let mask=null;                     // macchia 0/1
const dropzone=$('#dropzone'); const fileInput=$('#fileInput');
const force=$('#force'), forceVal=$('#forceVal');
const maxr=$('#maxr'), maxrVal=$('#maxrVal');
const btnRemoveGreen=$('#btnRemoveGreen');
const btnDownload=$('#btnDownload');
const btnReset=$('#btnReset');
const cnvOut=$('#cnvOut'); const octx=cnvOut.getContext('2d',{willReadFrequently:true});

/* ===== Upload ===== */
dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('drag')});
dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('drag'));
dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f) loadImage(f); });
fileInput.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) loadImage(f); });
document.addEventListener('paste',e=>{
  const it=e.clipboardData?.items||[]; for(const x of it){ if(x.type.startsWith('image/')){ loadImage(x.getAsFile()); break; } }
});

btnReset?.addEventListener('click',()=>{ 
  off=null; offCtx=null; lum=null; grad=null; mask=null; 
  cnvOut.width=cnvOut.height=0; fileInput.value=''; 
  if(btnRemoveGreen) btnRemoveGreen.disabled=true; 
  if(btnDownload) btnDownload.disabled=true;
  showToast('Ripristinato'); 
});

force.addEventListener('input',()=>{ forceVal.textContent=force.value; });
maxr.addEventListener('input',()=>{ maxrVal.textContent=maxr.value; });

/* ===== Core ===== */
function loadImage(file){
  if(!file.type.startsWith('image/')){ showToast('Seleziona un file immagine'); return; }
  const url=URL.createObjectURL(file);
  const img=new Image(); img.decoding='async';
  img.onload=()=>{
    // misura CSS entro 900x560
    const maxW=900, maxH=560;
    const r=Math.min(maxW/img.width, maxH/img.height, 1);
    const cssW=Math.round(img.width*r), cssH=Math.round(img.height*r);

    // canvas output
    setupCanvasHiDPI(cnvOut, cssW, cssH);

    // offscreen per pixel “alla scala giusta”
    off=document.createElement('canvas'); offCtx=setupCanvasHiDPI(off, cssW, cssH);
    offCtx.drawImage(img,0,0,cssW,cssH);

    // luminanza Uint8
    const data=offCtx.getImageData(0,0,off.width,off.height).data;
    const w=off.width,h=off.height;
    lum=new Uint8ClampedArray(w*h);
    for(let i=0,j=0; j<lum.length; i+=4,j++){
      lum[j] = Math.round(0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]);
    }

    // resistenza = gradiente (Sobel) normalizzato ~0..255
    grad = sobelMagnitude(lum, w, h);

    // disegna base e azzera macchia
    mask = new Uint8Array(w*h);
    if(btnRemoveGreen) btnRemoveGreen.disabled = true; // finché non c'è verde
    if(btnDownload) btnDownload.disabled = false;      // appena c'è immagine, si può scaricare
    redraw();
    showToast(`Immagine ${img.width}×${img.height} caricata • Clicca per espandere`);
  };
  img.onerror=()=>showToast('Impossibile caricare l’immagine');
  img.src=url;
}

/* Sobel grad magnitude → Uint8 0..255 (scala euristica) */
function sobelMagnitude(gray, w, h){
  const out=new Uint8ClampedArray(w*h);
  const idx=(x,y)=>y*w+x;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const xm1=Math.max(0,x-1), xp1=Math.min(w-1,x+1);
      const ym1=Math.max(0,y-1), yp1=Math.min(h-1,y+1);
      const a=gray[idx(xm1,ym1)], b=gray[idx(x,ym1)], c=gray[idx(xp1,ym1)];
      const d=gray[idx(xm1,y)],   e=gray[idx(x,y)],   f=gray[idx(xp1,y)];
      const g=gray[idx(xm1,yp1)], h1=gray[idx(x,yp1)], i=gray[idx(xp1,yp1)];
      const gx = (-a + c) + (-2*d + 2*f) + (-g + i);
      const gy = (-a -2*b -c) + (g + 2*h1 + i);
      const mag = Math.hypot(gx,gy)/4;  // scala euristica per stare ~0..255
      out[idx(x,y)] = mag>255?255:mag|0;
    }
  }
  return out;
}

/* Click → flood a soglia sulla resistenza (grad), limitato da R max */
cnvOut.addEventListener('click', (ev)=>{
  if(!off || !grad) return;
  const rect=cnvOut.getBoundingClientRect();
  const x = Math.floor((ev.clientX - rect.left) * (cnvOut.width / rect.width));
  const y = Math.floor((ev.clientY - rect.top)  * (cnvOut.height/ rect.height));
  regionGrow(x,y);
});

function regionGrow(sx,sy){
  const w=off.width,h=off.height;
  if(sx<0||sy<0||sx>=w||sy>=h) return;

  const F = parseInt(force.value,10);     // Forza utente
  const Rmax = parseInt(maxr.value,10);   // passi max (0 = illimitato)
  const visited = new Uint8Array(w*h);
  const dist = new Uint16Array(w*h); // passi Manhattan
  const qx=new Int32Array(w*h), qy=new Int32Array(w*h); let qs=0, qe=0;

  const push=(x,y,d)=>{ const i=y*w+x; visited[i]=1; dist[i]=d; qx[qe]=x; qy[qe]=y; qe++; };

  // condizione iniziale: accetto il seed se resistenza ≤ F (altrimenti nulla)
  if(grad[sy*w+sx] > F){ showToast('Seed troppo “duro”: aumenta Forza'); return; }
  push(sx,sy,0);

  // BFS 8-neigh con soglia locale sulla resistenza
  const N8=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1]];
  while(qs<qe){
    const x=qx[qs], y=qy[qs], d=dist[y*w+x]; qs++;
    for(const [dx,dy] of N8){
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=w||ny>=h) continue;
      const ni=ny*w+nx;
      if(visited[ni]) continue;
      const nd = d + 1;
      if(Rmax>0 && nd>Rmax) continue;
      // regola di accettazione: resistenza locale <= Forza
      if(grad[ni] <= F){
        push(nx,ny,nd);
      }
    }
  }

  // unisci alla maschera globale (nuova “pennellata”)
  for(let i=0;i<mask.length;i++) if(visited[i]) mask[i]=1;

  if(btnRemoveGreen){
    let has=false; for(let i=0;i<mask.length;i++){ if(mask[i]){has=true;break;} }
    btnRemoveGreen.disabled = !has;
  }
  redraw();
}

/* Elimina i pixel verdi (mask=1) rendendoli trasparenti nell'immagine */
btnRemoveGreen?.addEventListener('click', removeGreenAsBackground);

function removeGreenAsBackground(){
  if(!off || !mask) return;
  const w=off.width, h=off.height;
  const img = offCtx.getImageData(0,0,w,h);
  const d = img.data;

  let any = false;
  for(let j=0,k=0; j<mask.length; j++, k+=4){
    if(mask[j]){ d[k+3] = 0; any = true; }  // alpha = 0 → trasparente
  }
  if(!any){ showToast('Nessun pixel verde da eliminare'); return; }

  offCtx.putImageData(img,0,0);
  mask.fill(0);
  if(btnRemoveGreen) btnRemoveGreen.disabled = true;
  redraw();
  showToast('Sfondo verde eliminato (trasparente)');
}

/* === NUOVO: Scarica il PNG esattamente come lo vedi (con trasparenza) === */
btnDownload?.addEventListener('click', ()=>{
  if(!cnvOut.width || !cnvOut.height){ showToast('Nulla da scaricare'); return; }
  const url = cnvOut.toDataURL('image/png');
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url;
  a.download = `output-${ts}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

/* Disegna immagine + macchia (verde "green screen") */
function redraw(){
  if(!off) return;
  const w = off.width, h = off.height;

  // base
  octx.setTransform(1,0,0,1,0,0);
  octx.clearRect(0,0,cnvOut.width,cnvOut.height);
  octx.drawImage(off, 0, 0);
  if(!mask) return;

  // layer RGBA verde per i pixel mask=1
  const layer = document.createElement('canvas'); 
  layer.width = w; layer.height = h;
  const lctx = layer.getContext('2d', { willReadFrequently:true });
  const I = lctx.createImageData(w, h); 
  const a = I.data;

  let hasGreen=false;
  for(let j=0, k=0; j<mask.length; j++, k+=4){
    if(mask[j]){
      a[k]=16; a[k+1]=255; a[k+2]=32; a[k+3]=220; // verde key
      hasGreen=true;
    } else {
      a[k]=a[k+1]=a[k+2]=0; a[k+3]=0;
    }
  }
  lctx.putImageData(I, 0, 0);

  octx.globalCompositeOperation = 'source-over';
  octx.drawImage(layer, 0, 0);

  if(btnRemoveGreen) btnRemoveGreen.disabled = !hasGreen;
  if(btnDownload) btnDownload.disabled = !off; // se c'è immagine si può scaricare
}
</script>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
