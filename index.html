<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rimozione Sfondo(green screen)</title>
<meta name="description" content="Clicca o trascina: la macchia verde si espande finché il gradiente locale (forza resistente) è sotto la Forza scelta. Poi puoi rimuovere i pixel verdi come sfondo e scaricare il PNG. 100% client-side.">
<style>
  :root{ --bg1:#0f1226; --bg2:#0b0e1a; --muted:#8e95ad; --brand:#6a8dff; --brand2:#9d78ff;
         --card:#171a33; --radius:18px; --shadow:0 10px 25px rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.2); }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#e7e9f3;
    background: radial-gradient(1200px 600px at 10% -10%, #2631a7 0%, transparent 60%),
               radial-gradient(1200px 700px at 100% 0%, #6a22a8 0%, transparent 50%),
               linear-gradient(180deg, var(--bg1), var(--bg2));
    padding:28px; display:flex; align-items:center; justify-content:center;
  }
  .app{width:min(980px,100%)}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  .title{display:flex;align-items:center;gap:14px}
  .logo{width:42px;height:42px;display:grid;place-items:center;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:var(--shadow)}
  .logo svg{filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))}
  h1{font-size:clamp(18px,3vw,28px);margin:0}
  .muted{color:var(--muted)}
  .panel{background:rgba(23,26,51,.72);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
  .uploader{display:grid;grid-template-rows:auto 1fr auto}
  .top{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
  .badge{font-size:12px;line-height:1;padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
  .dropzone{margin:16px;border:1.5px dashed rgba(255,255,255,.18);border-radius:16px;display:grid;place-items:center;padding:20px;min-height:160px;
            background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));transition:.2s;text-align:center}
  .dropzone.drag{border-color:var(--brand);box-shadow:inset 0 0 0 2px rgba(106,141,255,.25)}
  .dropzone input{display:none}
  .dz-cta{display:flex;flex-direction:column;gap:10px;align-items:center}
  .btn{appearance:none;border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#0b0e1a;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:transparent;color:#e7e9f3;border:1px solid rgba(255,255,white,.16)}
  .btn[disabled]{opacity:.9;filter:grayscale(40%);cursor:not-allowed}
  .controls{display:flex;gap:14px;align-items:center;flex-wrap:wrap;padding:0 16px 16px 16px}
  .muted-sm{color:var(--muted);font-size:12px}
  .preview{margin:0 16px 16px 16px;border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;background:#0b0e1a}
  .preview-inner{max-height:560px;overflow:auto;display:grid;place-items:center;padding:12px}
  .checker{background-image:linear-gradient(45deg,#999 25%,transparent 25%),linear-gradient(-45deg,#999 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#999 75%),linear-gradient(-45deg,transparent 75%,#999 75%);
           background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0}
  .preview-inner{max-width:100%}
  canvas{display:block; max-width:100%; height:auto; cursor: crosshair;}

  .controls-float{
    position: fixed;
    right: 16px;
    bottom: max(16px, env(safe-area-inset-bottom));
    z-index: 3000;
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    background: rgba(18,20,38,.72);
    border: 1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(6px);
    box-shadow: var(--shadow);
  }

  .toast{position:fixed;z-index:3200;right:18px;bottom:72px;background:#121426;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.2s ease}
  .toast.show{opacity:1;transform:translateY(0)}

  .num {appearance:textfield; background:rgba(255,255,255,.04); color:#e7e9f3; border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:10px 12px; width:86px; font-weight:700;}
  .num::-webkit-outer-spin-button,.num::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }

  .splash-logo{
    width:96px;height:96px;border-radius:16px;box-shadow:var(--shadow);object-fit:contain;background:transparent;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35));
  }
  #splash .splash-logo{ transform: scale(.98); animation: logoPop .6s ease .2s forwards; }
  @keyframes logoPop{ to { transform: scale(1); } }

  @keyframes fadeOut{to{opacity:0;visibility:hidden}}
  @keyframes floatBg{0%{transform:translate3d(0,0,0) scale(1)}100%{transform:translate3d(-2%,-2%,0) scale(1.03)}}
  @media (prefers-reduced-motion: reduce){ #splash{animation:none} .splash-bg{animation:none} }
  .logo{
  width:42px;height:42px;display:grid;place-items:center;
  border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));
  box-shadow:var(--shadow); overflow:hidden; /* importante per ritaglio pulito */
}
.logo picture, .logo img{ width:100%; height:100%; display:block; object-fit:contain; }

</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
		<!-- LOGO (sostituisce l'SVG inline) -->
		<a href="#" class="logo" aria-label="DP Web & Design">
		  <picture>
			<source srcset="assets/logo.png" type="image/svg+xml" />
			<source srcset="assets/logo@2x.png 2x, assets/logo.png 1x" type="image/png" />
			<img class="logo-img" src="assets/logo.png" alt="DP Web & Design" width="42" height="42" loading="eager" decoding="async" />
		  </picture>
		</a>

        <div>
          <h1>Rimozione sfondo — DP Web & Design</h1>
          <div class="muted">Clicca o trascina sull’immagine. La macchia si espande finché la resistenza (gradiente) ≤ Forza.</div>
        </div>
      </div>
    </header>

    <div class="controls-float">
      <button class="btn secondary" id="btnUndo" disabled>Annulla ultimo (Ctrl+Z)</button>
      <button class="btn secondary" id="btnRemoveGreen" disabled>Rimuovi verde</button>
      <button class="btn secondary" id="btnDownload" disabled>Scarica PNG</button>
      <button class="btn secondary" id="btnReset">Ripristina</button>
    </div>

    <section class="panel uploader">
      <div class="top">
        <span class="badge">1</span>
        <div>
          <div style="font-weight:700">Carica o trascina una foto, poi CLICCA o trascina per espandere</div>
          <div class="muted-sm">JPG, PNG, WebP • 100% offline</div>
        </div>
      </div>

      <div class="dropzone" id="dropzone" aria-live="polite">
        <div class="dz-cta">
          <div class="muted">Trascina qui l’immagine</div>
          <div class="muted"> </div>
          <div><label class="btn" for="fileInput">Scegli file</label><input id="fileInput" type="file" accept="image/*"/></div>
        </div>
      </div>

      <div class="controls">
        <span class="badge">2</span>
        <label style="display:flex;align-items:center;gap:10px">
          <span class="muted-sm">Forza (0–255)</span>
          <input id="force" class="num" type="number" inputmode="numeric" min="0" max="255" value="10" />
        </label>
        <label style="display:flex;align-items:center;gap:10px">
          <span class="muted-sm">Raggio max (px, 0=∞)</span>
          <input id="maxr" class="num" type="number" inputmode="numeric" min="0" max="5000" value="20" />
        </label>
        <span class="muted-sm">Tip: valori bassi seguono i bordi, alti “sfondano”. Rotellina disattivata sugli input.</span>
      </div>

      <div class="preview checker">
        <div class="preview-inner">
          <canvas id="cnvOut"></canvas>
        </div>
      </div>
    </section>
  </div>

  <div id="splash"
       aria-hidden="true"
       style="position:fixed;inset:0;z-index:4000;display:grid;place-items:center;background:#0f1226;color:#fff;
              font-family:inherit;font-size:clamp(26px,4vw,48px);font-weight:900;letter-spacing:.8px;animation:fadeOut .9s ease 1.4s forwards;">
    <div class="splash-bg" style="position:absolute;inset:-20%;
      background:radial-gradient(1200px 600px at 10% -10%, #2631a7 0%, transparent 60%),
                 radial-gradient(1200px 700px at 100% 0%, #6a22a8 0%, transparent 50%),
                 radial-gradient(900px 500px at 20% 120%, #0ea5e9 0%, transparent 55%);
      filter:blur(30px);opacity:.85;animation:floatBg 8s ease-in-out infinite alternate;"></div>
    <div style="position:relative;display:grid;place-items:center;gap:12px;text-align:center;padding:16px 22px">
      <img id="splashLogo"
           class="splash-logo"
           src="assets/logo.png"
           alt="DP Web & Design"
           width="96" height="96"
           decoding="async"
           fetchpriority="high" />
      <div>DP Web & Design</div>
      <button id="skipSplash" class="btn secondary" style="padding:10px 14px;border-radius:12px;cursor:pointer">Entra subito</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Helpers & Splash ===== */
const $=s=>document.querySelector(s);
const showToast=msg=>{const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)};
(function(){const s=$('#splash'), b=$('#skipSplash'); const rm=()=>{if(!s) return; s.style.animation='fadeOut .5s ease forwards'; setTimeout(()=>s.remove(),520)}; setTimeout(rm,1600); b?.addEventListener('click',rm);})();

/* ===== HiDPI canvas ===== */
function setupCanvasHiDPI(cnv, cssW, cssH){
  const dpr=window.devicePixelRatio||1;
  cnv.width=Math.max(1,Math.round(cssW*dpr));
  cnv.height=Math.max(1,Math.round(cssH*dpr));
  cnv.style.width=cssW+'px';
  cnv.style.height=cssH+'px';
  const ctx=cnv.getContext('2d',{willReadFrequently:true});
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled=true;
  ctx.imageSmoothingQuality='high';
  return ctx;
}

/* ===== Stato & Riferimenti ===== */
let off=null, offCtx=null;
let lum=null, grad=null;
let mask=null;
let maskHistory=[];
const dropzone=$('#dropzone'); const fileInput=$('#fileInput');
const force=$('#force');
const maxr=$('#maxr');
const btnUndo=$('#btnUndo');
const btnRemoveGreen=$('#btnRemoveGreen');
const btnDownload=$('#btnDownload');
const btnReset=$('#btnReset');
const cnvOut=$('#cnvOut'); const octx=cnvOut.getContext('2d',{willReadFrequently:true});

/* ===== Blocca rotellina sugli input numerici ===== */
for (const n of [force,maxr]) {
  n.addEventListener('wheel', e => { if (document.activeElement === n) { e.preventDefault(); n.blur(); } }, {passive:false});
  n.addEventListener('change', ()=> clampNumber(n));
  n.addEventListener('blur', ()=> clampNumber(n));
}
function clampNumber(el){
  const min = parseInt(el.min ?? '-2147483648',10);
  const max = parseInt(el.max ?? '2147483647',10);
  let v = parseInt(el.value||'0',10);
  if (Number.isNaN(v)) v=min;
  v = Math.min(max, Math.max(min, v));
  el.value = String(v);
}

/* ===== Upload ===== */
dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('drag')});
dropzone.addEventListener('dragleave',()=>dropzone.classList.remove('drag'));
dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('drag'); const f=e.dataTransfer.files?.[0]; if(f) loadImage(f); });
fileInput.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) loadImage(f); });
document.addEventListener('paste',e=>{
  const it=e.clipboardData?.items||[]; for(const x of it){ if(x.type.startsWith('image/')){ loadImage(x.getAsFile()); break; } }
});

btnReset?.addEventListener('click',()=>{ 
  off=null; offCtx=null; lum=null; grad=null; mask=null; maskHistory.length=0;
  cnvOut.width=cnvOut.height=0; fileInput.value='';
  if(btnRemoveGreen) btnRemoveGreen.disabled=true; 
  if(btnDownload) btnDownload.disabled=true;
  if(btnUndo) btnUndo.disabled=true;
  showToast('Ripristinato'); 
});

/* ===== Core ===== */
function loadImage(file){
  if(!file.type.startsWith('image/')){ showToast('Seleziona un file immagine'); return; }
  const url=URL.createObjectURL(file);
  const img=new Image(); img.decoding='async';
  img.onload=()=>{
    const maxW=900, maxH=560;
    const r=Math.min(maxW/img.width, maxH/img.height, 1);
    const cssW=Math.round(img.width*r), cssH=Math.round(img.height*r);

    setupCanvasHiDPI(cnvOut, cssW, cssH);

    off=document.createElement('canvas'); offCtx=setupCanvasHiDPI(off, cssW, cssH);
    offCtx.drawImage(img,0,0,cssW,cssH);

    const data=offCtx.getImageData(0,0,off.width,off.height).data;
    const w=off.width,h=off.height;
    lum=new Uint8ClampedArray(w*h);
    for(let i=0,j=0; j<lum.length; i+=4,j++){
      lum[j] = Math.round(0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]);
    }
    grad = sobelMagnitude(lum, w, h);

    mask = new Uint8Array(w*h);
    maskHistory.length=0;
    if(btnRemoveGreen) btnRemoveGreen.disabled = true;
    if(btnDownload) btnDownload.disabled = false;
    if(btnUndo) btnUndo.disabled = true;
    redraw();
    showToast(`Immagine ${img.width}×${img.height} caricata • Clic/drag per espandere`);
  };
  img.onerror=()=>showToast('Impossibile caricare l’immagine');
  img.src=url;
}

/* Sobel grad magnitude → Uint8 0..255 */
function sobelMagnitude(gray, w, h){
  const out=new Uint8ClampedArray(w*h);
  const idx=(x,y)=>y*w+x;
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const xm1=Math.max(0,x-1), xp1=Math.min(w-1,x+1);
      const ym1=Math.max(0,y-1), yp1=Math.min(h-1,y+1);
      const a=gray[idx(xm1,ym1)], b=gray[idx(x,ym1)], c=gray[idx(xp1,ym1)];
      const d=gray[idx(xm1,y)],   e=gray[idx(x,y)],   f=gray[idx(xp1,y)];
      const g=gray[idx(xm1,yp1)], h1=gray[idx(x,yp1)], i=gray[idx(xp1,yp1)];
      const gx = (-a + c) + (-2*d + 2*f) + (-g + i);
      const gy = (-a -2*b -c) + (g + 2*h1 + i);
      const mag = Math.hypot(gx,gy)/4;
      out[idx(x,y)] = mag>255?255:mag|0;
    }
  }
  return out;
}

/* === UNDO === */
document.addEventListener('keydown', (e)=>{ if((e.ctrlKey || e.metaKey) && (e.key==='z' || e.key==='Z')){ e.preventDefault(); undoLast(); }});
btnUndo?.addEventListener('click', undoLast);
function pushHistory(){ if(!mask) return; maskHistory.push(mask.slice()); if(btnUndo) btnUndo.disabled = true===false || maskHistory.length>0; const N=50; if(maskHistory.length>N) maskHistory.splice(0, maskHistory.length-N); }
function undoLast(){
  if(!maskHistory.length){ showToast('Niente da annullare'); return; }
  mask = maskHistory.pop();
  if(btnUndo) btnUndo.disabled = maskHistory.length===0;
  if(btnRemoveGreen){
    let has=false; for(let i=0;i<mask.length;i++){ if(mask[i]){has=true;break;} }
    btnRemoveGreen.disabled = !has;
  }
  redraw();
  showToast('Ultima azione annullata');
}

/* ===== Espansione circolare (region grow) =====
   - Rmax espresso in pixel (raggio)
   - usa distanza euclidea dal seed per avere macchia perfettamente circolare
*/
function regionGrow(sx,sy, doHistory=true, silent=false){
  const w=off.width,h=off.height;
  if(sx<0||sy<0||sx>=w||sy>=h) return false;

  const F = Math.min(255, Math.max(0, parseInt(force.value||'0',10)));
  const Rmax = Math.max(0, parseInt(maxr.value||'0',10));
  const R2 = Rmax>0 ? Rmax*Rmax : 0;

  const visited = new Uint8Array(w*h);
  const qx=new Int32Array(w*h), qy=new Int32Array(w*h); let qs=0, qe=0;

  const idx=(x,y)=>y*w+x;
  const push=(x,y)=>{ const i=idx(x,y); visited[i]=1; qx[qe]=x; qy[qe]=y; qe++; };

  if(grad[idx(sx,sy)] > F){ if(!silent) showToast('Seed troppo “duro”: aumenta Forza'); return false; }
  push(sx,sy);

  const seedX=sx, seedY=sy;
  const N8=[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[1,-1],[1,1],[-1,1]];
  while(qs<qe){
    const x=qx[qs], y=qy[qs]; qs++;
    for(const [dx,dy] of N8){
      const nx=x+dx, ny=y+dy;
      if(nx<0||ny<0||nx>=w||ny>=h) continue;
      const ni=idx(nx,ny);
      if(visited[ni]) continue;

      if(Rmax>0){
        const ddx=nx-seedX, ddy=ny-seedY;
        if(ddx*ddx + ddy*ddy > R2) continue; // vincolo circolare
      }
      if(grad[ni] <= F){
        push(nx,ny);
      }
    }
  }

  // verifica se è cresciuta
  let grown=false;
  for(let i=0;i<visited.length;i++){ if(visited[i] && !mask[i]) { grown=true; break; } }
  if(!grown) return false;

  if(doHistory) pushHistory();
  for(let i=0;i<mask.length;i++) if(visited[i]) mask[i]=1;

  if(btnRemoveGreen){
    let has=false; for(let i=0;i<mask.length;i++){ if(mask[i]){has=true;break;} }
    btnRemoveGreen.disabled = !has;
  }
  redraw();
  return true;
}

/* ======= Interazione: click + drag ======= */
function clientToCanvasXY(clientX, clientY){
  const rect=cnvOut.getBoundingClientRect();
  const x = Math.floor((clientX - rect.left) * (cnvOut.width / rect.width));
  const y = Math.floor((clientY - rect.top)  * (cnvOut.height/ rect.height));
  return {x,y};
}

cnvOut.addEventListener('click', (ev)=>{ if(!off || !grad) return; const {x,y}=clientToCanvasXY(ev.clientX, ev.clientY); regionGrow(x,y,true,false); });

let dragging=false, lastX=0, lastY=0;
const STEP_PX = 4;

cnvOut.addEventListener('pointerdown', (ev)=>{
  if(!off || !grad) return;
  cnvOut.setPointerCapture(ev.pointerId);
  const {x,y}=clientToCanvasXY(ev.clientX, ev.clientY);
  dragging=true; lastX=x; lastY=y;
  pushHistory();
  regionGrow(x,y,false,true);
});

cnvOut.addEventListener('pointermove', (ev)=>{
  if(!dragging) return;
  const {x,y}=clientToCanvasXY(ev.clientX, ev.clientY);
  const dx=x-lastX, dy=y-lastY; const len=Math.hypot(dx,dy);
  const n = Math.max(1, Math.ceil(len/STEP_PX));
  for(let i=1;i<=n;i++){
    const t=i/n;
    const px=Math.round(lastX + dx*t);
    const py=Math.round(lastY + dy*t);
    regionGrow(px,py,false,true);
  }
  lastX=x; lastY=y;
});

function endDrag(ev){
  if(!dragging) return;
  dragging=false;
  showToast('Pennellata applicata');
  try{ cnvOut.releasePointerCapture(ev.pointerId); }catch{}
}
cnvOut.addEventListener('pointerup', endDrag);
cnvOut.addEventListener('pointercancel', endDrag);
cnvOut.addEventListener('pointerleave', endDrag);

/* ===== Rimozione e Download ===== */
btnRemoveGreen?.addEventListener('click', removeGreenAsBackground);

function removeGreenAsBackground(){
  if(!off || !mask) return;
  const w=off.width, h=off.height;
  const img = offCtx.getImageData(0,0,w,h);
  const d = img.data;

  let any = false;
  for(let j=0,k=0; j<mask.length; j++, k+=4){
    if(mask[j]){ d[k+3] = 0; any = true; }
  }
  if(!any){ showToast('Nessun pixel verde da eliminare'); return; }

  offCtx.putImageData(img,0,0);
  mask.fill(0);
  maskHistory.length=0;
  if(btnRemoveGreen) btnRemoveGreen.disabled = true;
  if(btnUndo) btnUndo.disabled = true;
  redraw();
  showToast('Sfondo verde eliminato (trasparente)');
}

btnDownload?.addEventListener('click', ()=>{
  if(!cnvOut.width || !cnvOut.height){ showToast('Nulla da scaricare'); return; }
  const url = cnvOut.toDataURL('image/png');
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url;
  a.download = `output-${ts}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

/* Disegna immagine + macchia (verde "green screen") */
function redraw(){
  if(!off) return;
  const w = off.width, h = off.height;

  octx.setTransform(1,0,0,1,0,0);
  octx.clearRect(0,0,cnvOut.width,cnvOut.height);
  octx.drawImage(off, 0, 0);
  if(!mask) return;

  const layer = document.createElement('canvas'); 
  layer.width = w; layer.height = h;
  const lctx = layer.getContext('2d', { willReadFrequently:true });
  const I = lctx.createImageData(w, h); 
  const a = I.data;

  let hasGreen=false;
  for(let j=0, k=0; j<mask.length; j++, k+=4){
    if(mask[j]){
      a[k]=16; a[k+1]=255; a[k+2]=32; a[k+3]=220;
      hasGreen=true;
    } else {
      a[k]=a[k+1]=a[k+2]=0; a[k+3]=0;
    }
  }
  lctx.putImageData(I, 0, 0);

  octx.globalCompositeOperation = 'source-over';
  octx.drawImage(layer, 0, 0);

  if(btnRemoveGreen) btnRemoveGreen.disabled = !hasGreen;
  if(btnDownload) btnDownload.disabled = !off;
}
</script>
</body>
</html>

